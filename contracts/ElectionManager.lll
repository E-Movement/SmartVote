; ------------------------------------------------------------------------------
; ElectionManager
; ------------------------------------------------------------------------------
; - create contracts for elections.
; - keep track of all the elections.
; ------------------------------------------------------------------------------

{
    ; init
    (include "./defs/stdll.def")
    (include "./env.def")
    (include "./Election.lll")

    ; --------------------------------------------------------------------------
    ; macros
    ; --------------------------------------------------------------------------
    ; for constants
    (def 'DOUG 0xabcdef)

    ; for parameters
    (def 'CMD () (CALLDATALOAD 0x0))

    ; --------------------------------------------------------------------------
    ; variables
    ; --------------------------------------------------------------------------
    (llInit "elections" "none" "none" "none")    ; all elections

    (return 0 (lll {
        ; body
        ; ----------------------------------------------------------------------
        ; Create a contract for a new election.
        ; ----------------------------------------------------------------------
        ; Calldata: "createElection" ELECTION_ADDRESS
        ; Returns:
        ;     0 - fail
        ;     0xADDRESS - the address of the newly created contract
        ; ----------------------------------------------------------------------
        (when (= (CMD) "createElection") {
            ; first check if the name has already taken
            (unless (= (llGet "elections" (ELECTION_ADDRESS)) 0) (STOP))
            
            ; then check if the caller is an organizer
            [0x0]"checkContract
            [0x20]"AccountManager"
            (CALL (GASS) DOUG 0 0x0 0x40 0x40 0x20)
            (when (= @0x40 0) (STOP))
            [0x0]"checkOrganizer"
            [0x20](CALLER)
            (CALL (GASS) @0x40 0 0x0 0x40 0x40 0x20)
            (when (= @0x40 0) (STOP))
            
            ; create the contract and save its address in memory 0x20
            [0x20](create 0 0 (lll {
                (election)
            } 0))
            [[@0x20]]1
            
            (llAddLink "elections" @0x0 @0x0)
            
            ; register the contract in the organizer's account
            [0x0]"registerElection"
            (CALL (GASS) @0x40 0 0x20 0x40 0x60 0x20)

            (return 0x20 0x20)
        })

        ; ----------------------------------------------------------------------
        ; Delete an election (called by the election itself)
        ; ----------------------------------------------------------------------
        ; Calldata: "rmElection"
        ; Returns: 0 - fail | 1 - success
        ; ----------------------------------------------------------------------
        (when (= (CMD) "rmElection") {
            ; check if the election is recorded
            (when (= 0 (llGet "elections" (CALLER))) (STOP))

            (llRmLink "elections" @0x0)

            [0x0]1
            (return 0x0 0x20)
        })
    })

}