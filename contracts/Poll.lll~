; ---------------------------------------------
; Poll - the contract
; ---------------------------------------------
; ---------------------------------------------

;Track every poll

(def 'poll () {
    (include "./env.def")
    (include "./defs/stdll.def")
    (include "./defs/single.def")

    (def 'cmd () (calldataload 0x0))
	
    (def 'status () (calldataload 0x20)))
	
    (def 'newopentime () (calldataload 0x20))
	
    (def 'newclosetime () (calldataload 0x20))
	
    (def 'opnum () (calldataload 0x20)) ;The number of options
    (def 'hash () (calldataload 0x40))
    (def 'opentime () (calldataload 0x60))
    (def 'closetime () (calldataload 0x80))
    (def 'createtime () (calldataload 0xA0))
    (def 'creator () (calldataload 0xC0)) ;The address of the creator
    (def 'plname () (calldataload 0xCE0)) ;The name of the poll

    (kvInit "ops") ;The statistics of the options
	
    (singleInit "description" 0)
    (singleInit "inited" 0)
    (singleInit "created" 0)
    (singleInit "opened" 0)
    (singleInit "closed" 0)
	(singleInit "created" 0)
    (singleInit "status" 0) ;0:closed, 1:opened
    (singleInit "owner" (ORIGIN))
    (singleInit "creator" 0)
    (singleInit "opnum" 1)
    (singleInit "plname" 0)
	
	(return 0 (lll{
		[[0xcccc]](gass)
		(when (&& (= (cmd) "init") (= (singleGet "inited") 0)) {
			(singleSet "description" (hash))
			[0x0](opnum)
			(for ([0x20]1) (<= @0x20 @0x0) [0x20](+ @0x20 1)
				(kvSet "ops" @0x20 0)
			)
			(singleSet "opnum" @0x0)
			(singleSet "opened" (opentime))
			(singleSet "closed" (closetime))
			(singleSet "created" (createtime))
			(singleSet "creator" (crtusrname))
			(singleSet "plname" (plname))
			(singleSet "inited" 1)
			
			[0x0]1
			(return 0x0 0x20)
		}
	)

;(when (&& (= (cmd) "getopentime") (= (singleGet "inited") 1)) {
;   [0x0]"opened"
;   (return 0x0 0x20)
;})

;(when (&& (= (cmd) "getclosetime") (= (singleGet "inited") 1)) {
;   [0x0]"closed"
;   (return 0x0 0x20)
;})

		(when (&& (= (cmd) "setopentime") (= (singleGet "inited") 1)) {
			(singleSet "opentime" (newopentime))

			[0x0]1
			(return 0x0 0x20)
		})

		(when (&& (= (cmd) "setclosetime") (= (singleGet "inited") 1)) {
			(singleSet "closetime" (newclosetime))

			[0x0]1
			(return 0x0 0x20)
		})

		(when (&& (= (cmd) "setstatus") (= (singleGet "inited") 1))
			{
				(singleSet "status" (status))

				[0x0]1
				(return 0x0 0x20)
			}
		)

		(when (&& (= (cmd) "vote") (= (singleGet "status") 1)) {
			(kvSet "ops" (opnum) (+ (kvGet "ops" (opnum)) 1))

			[0x0]1
			(return 0x0 0x20)
		})

		(when (&& (= (cmd) "getstat") (= (singleGet "inited") 1)) {
			[0x0](kvGet "ops" (opnum))
			(return 0x0 0x20)
		})

        (when (= (cmd) "deletePoll") {
            ; get the address of the PollFactory contract
            ; and save it in memory 0x60
            [0x0]"getContractAddr"
            [0x20]"PollFactory"
            (CALL (gass) DAPPDOUG 0 0x0 0x40 0x60 0x20)
            
            [0x0]"deletePoll"
            [0x20](singleGet "pollname")
            (CALL (gass) @0x60 0 0x0 0x40 0x40 0x20)
            
            (unless (= @0x40 1) (STOP))
            
            (suicide (ORIGIN))    ; ???????????????????????????????????????????
        })
        
    } 0)) ; end of return
})
